# 개발 요구 문서 — 굴착기 IK/FK 2D UI (PyQt5)

## 1. 개요
- **목적**: 30톤급 굴착기의 붐–암–버킷 3자유도(평면) 기구학/역기구학을 시각적으로 조작·검증할 수 있는 데스크톱 UI 제공
- **대상 사용자**: 연구원/엔지니어(제어/기구학/시뮬레이션), 교육용 데모 사용자
- **성과물**: 실행 가능한 PyQt5 애플리케이션(`excavator_ui.py`)과 의존성(`requirements.txt`)

## 2. 범위
- 평면 2D 모델(스윙/차체 요 회전은 0으로 고정)
- 링크: 붐(boom)–암(arm)–버킷(bucket)
- 조작 모드: 기구학(FK), 역기구학(IK)

## 3. 기능 요구사항 (Functional Requirements)
- **UI 레이아웃**
  - 상단: 2D 굴착기 링크 도식(실시간 갱신, 안티앨리어싱)
  - 중단: 모드 토글 버튼
    - `역기구학 (IK)` 버튼
    - `기구학 (FK)` 버튼
  - 하단: 슬라이더/스핀박스 세트
    - IK 모드: `x (m)`, `y (m)`, `theta (deg)`
    - FK 모드: `붐 (deg)`, `암 (deg)`, `버킷 (deg)`
- **기구학(FK)**
  - 입력: 붐/암/버킷 각도(도)
  - 출력: 각 관절과 말단(p0~p3) 위치(장면에 갱신)
- **역기구학(IK)**
  - 입력: 말단 포즈(x, y, theta)
  - 방식: 팔꿈치 위/아래(elbow up/down) 두 해 선택, 현재 관절각과의 거리 최소 해 선택
  - 제약: 관절각 한계 내로 클램프 또는 불가 시 이전 상태 유지
- **실시간 반영**
  - 슬라이더/스핀 값 변경 시 즉시 상단 그림 업데이트
  - 모드 전환 시 해당 컨트롤 세트로 즉시 스위칭

## 4. 비기능 요구사항 (Non‑Functional Requirements)
- **성능**: 슬라이더 이동 시 체감 지연 < 50 ms
- **호환성**: Windows 10+, Python 3.10+, PyQt5 5.15+
- **신뢰성**: 역기구학 해 없을 때 크래시 금지, 이전 자세 유지
- **코드 품질**: 가독성 높은 명명, 최소 중첩, 신호/슬롯 사용(부모 위젯 체인 의존 금지)

## 5. 파라미터/데이터
- 30톤급 근사 링크 길이 (m)
  - 붐: 6.15, 암: 3.20, 버킷 유효 길이: 1.50
- 관절 한계 (deg)
  - 붐: [0, 75], 암: [-130, 130], 버킷: [-120, 120]

## 6. 알고리즘 요구사항
- **Forward Kinematics**: 3-링크 평면 체인, 연속 합각을 사용한 좌표 계산
- **Inverse Kinematics**:
  - 손목점(wrist) 계산: (x - l3 cosθ, y - l3 sinθ)
  - 코사인 법칙으로 암 각도(q2) 계산, q1는 atan2 조합, q3 = θ − (q1+q2)
  - 도달성 검사: r ∈ [|l1-l2|, l1+l2]
  - 후보 중 현재 관절과의 L1 거리 최소 해 선택, 한계 초과 시 클램프

## 7. UI/UX 세부
- 안티앨리어싱: `QPainter.Antialiasing`
- 스핀박스와 슬라이더 양방향 동기화, 단위 표시(도/미터)
- 값 변경 이벤트는 Qt 시그널(`valueChanged`)로 상위 컨트롤러에 전달

## 8. 에러/예외 처리
- 역기구학 불가: 사용자 입력 유지, 시각적 경고는 1차 범위에서 생략(크래시 방지 우선)
- 수치 안정성: acos 입력 클램프, 0 근처 거리 가드

## 9. 수용 기준 (Acceptance Criteria)
- 앱이 오류 없이 실행된다.
- IK/FK 모드 전환 시 컨트롤이 적절히 바뀐다.
- 슬라이더 이동 시 상단 도식이 즉시 갱신된다.
- FK: 각도 조절에 따른 링크 위치가 기하적으로 일관된다.
- IK: x/y/theta 변경 시 관절 각이 합리적으로 계산되며 한계 범위 내에 존재한다.
- 부모 위젯 체인 호출 없이 시그널 기반 업데이트를 사용한다.
- 안티앨리어싱이 적용되어 선이 매끄럽다.

## 10. 테스트 계획
- **기능 테스트(수동)**
  - FK: 각도 0→최대/최소 이동 시 링크 길이 보존, 연속성 확인
  - IK: 말단 반경 밖 좌표 입력 시 자세 유지(크래시 없음)
  - 모드 전환: 컨트롤 세트 교체 및 값 동기 확인
- **수치 스팟체크**
  - (x, y, θ) = FK로 계산 후 IK에 입력 → 원 각도와 근접(허용오차: 1e-2 rad 수준)

## 11. 개발 환경/의존성
- Python 3.10+
- PyQt5 5.15+: `requirements.txt` 참조

## 12. 빌드/실행
```bash
python -m pip install -r requirements.txt
python excavator_ui.py
```

## 13. 저장소/버전 관리
- 기본 브랜치: `main`
- 커밋 메시지 규칙(권장): `feat|fix|chore: …`
- `.gitignore`: 파이썬/IDE/환경 파일 제외

## 14. 향후 개선 항목(로드맵)
- 스윙(요) 추가, 지면/차체/실린더 그래픽 디테일
- 충돌/작업반경 시각화, 버킷 궤적/용적 근사
- 단위계 선택, 국제화(i18n)

## 15. 산출물
- `excavator_ui.py`, `requirements.txt`, `.gitignore`, `excavator_ui_prompt.md`, 본 문서(`개발_요구_문서_굴착기_UI.md`)

## 16. 용어
- FK(Forward Kinematics): 관절각 → 말단 위치/자세
- IK(Inverse Kinematics): 말단 위치/자세 → 관절각
